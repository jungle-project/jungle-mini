<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¹­ì°¬í•˜ê¸°</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="bg-white min-w-[300px] max-w-[360px] mx-auto rounded-lg shadow-lg">

  {% include 'login/header.html' %}

  <main class="p-4 space-y-4 text-sm">
    <!-- í”„ë¡œí•„ ë¹„êµ: ì‘ê²Œ -->
    <div class="flex justify-evenly">
      <div class="flex flex-col items-center">
        <img id="toPhoto"
             src="{{ url_for('static', filename='img/profile.png') }}"
             alt="ìˆ˜ì‹ ì¸"
             class="w-12 h-12 rounded-full mb-1" />
        <span id="toName" class="truncate w-16 text-center">ìˆ˜ì‹ ì¸</span>
      </div>
    </div>

    <!-- ì…ë ¥ í¼: ì»´íŒ©íŠ¸ -->
    <section>
      {% if mode == 'readonly' %}
        <textarea id="praiseInput"
                  rows="3"
                  class="w-full h-30 resize-none border-gray-300 rounded px-2 py-1 focus:outline-none"
                  disabled></textarea>
      {% else %}
        <textarea id="praiseInput"
                  rows="3"
                  class="w-full h-30 resize-none border-gray-300 rounded px-2 py-1 focus:outline-none"
                  placeholder="ì¹­ì°¬ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (50ì ì´ë‚´)"></textarea>
      {% endif %}
    </section>

    <!-- ë²„íŠ¼ ê·¸ë£¹: ì‘ê²Œ -->
    <section class="flex justify-between">
      {% if mode != 'readonly' %}
        <button id="submitPraise"
                class="flex-1 bg-blue-500 text-white px-4 py-1 rounded mr-1 text-sm">
          ë“±ë¡
        </button>
      {% endif %}
      <a href="{{ url_for('main_page') }}"
         id="cancelPraise"
         class="flex-1 bg-gray-200 text-gray-700 px-4 py-1 rounded ml-1 text-sm">
        ë‹«ê¸°
      </a>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 1) sessionStorageì—ì„œ selectedUser êº¼ë‚´ê¸°
      const raw = sessionStorage.getItem('selectedUser');
      if (!raw) {
        alert('ì¹­ì°¬í•  ì‚¬ìš©ìê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        window.close();
        return;
      }
      // 2) êº¼ë‚¸ ì§í›„ ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì—ì„œ ì œê±° (í•œ ë²ˆë§Œ ì‚¬ìš©)
      sessionStorage.removeItem('selectedUser');

      const user = JSON.parse(raw);
      // 3) UI ì´ˆê¸°í™”
      document.getElementById("toName").textContent = user.name;
      document.getElementById("toPhoto").src        = user.photo;
      const to_id = user._id;
      
      // 4) ë“±ë¡ í•¸ë“¤ëŸ¬
      async function submitPraiseHandler() {
        const content = document.getElementById("praiseInput").value.trim();
        if (!content) {
          alert("ì¹­ì°¬ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        try {
          // ë‚´ ì •ë³´ ì¡°íšŒ
          const meRes  = await fetch("/auth/me", {
            method: "GET",
            credentials: "include"
          });
          if (!meRes.ok) throw new Error("ë‚´ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");
          const meData = await meRes.json();
          const from_id = meData.user_id || meData._id;

          // ì¹­ì°¬ ì „ì†¡
          const payload = { to_id, from_id, content };
          const praiseRes = await fetch("/praises", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(payload)
          });
          if (!praiseRes.ok) throw new Error("ì¹­ì°¬ ì „ì†¡ ì‹¤íŒ¨");

          alert("ì¹­ì°¬ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰");
          window.close();
        } catch (err) {
          console.error(err);
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      }

      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      const submitBtn = document.getElementById('submitPraise');
      if (submitBtn) submitBtn.addEventListener('click', submitPraiseHandler);

      const cancelBtn = document.getElementById('cancelPraise');
      cancelBtn.addEventListener('click', () => window.close());
    });
  </script>
</body>

</html>
